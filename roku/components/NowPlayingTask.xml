<?xml version="1.0" encoding="utf-8" ?> 

<component name="NowPlayingTask" extends="Task">

  <interface>
      <field id="name" type="string" value=""/>
      <field id="uri" type="string" value=""/>
  </interface>

  <script type = "text/brightscript" uri = "pkg:/components/Requests.brs" />

  <script type="text/brightscript" >
    <![CDATA[
    
      sub init()
          m.top.functionName = "pingServer"
      end sub

      sub pingServer()
        data = {
            "query": "query GetNowPlaying { nowPlaying { __typename ... on Video { name, uri, lastPlayedEpoch } ... on NothingPlaying { tryAgainInSec } } }"
        }
        print "Pinging server..."
        response = Requests().post("http://192.168.1.22:2222/graphql", {"json": data})

        if (response.statuscode = 200) then
          res = response.json["data"]["nowPlaying"]
          if (res["__typename"] = "Video") then
            print "There's something on: " + res.name
            m.top.name = res.name
            m.top.uri = res.uri
          else
            print "There's nothing on. Trying again in " + res.tryAgainInMin + "minutes..."
          end if
        end if
      end sub

  ]]>
  </script>

</component>
